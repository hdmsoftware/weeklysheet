{"version":3,"sources":["../../../../server/api/user/user.controller.js"],"names":["index","create","show","destroy","changePassword","me","authCallback","validationError","res","statusCode","err","status","json","handleError","send","req","findAll","attributes","then","users","catch","next","newUser","build","body","setDataValue","save","user","token","sign","_id","secrets","session","expiresIn","userId","params","id","find","where","end","profile","oldPass","String","oldPassword","newPass","newPassword","authenticate","password","redirect"],"mappings":"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","file":"user.controller.js","sourcesContent":["'use strict';\n\nimport {User} from '../../sqldb';\nimport passport from 'passport';\nimport config from '../../config/environment';\nimport jwt from 'jsonwebtoken';\n\nfunction validationError(res, statusCode) {\n  statusCode = statusCode || 422;\n  return function(err) {\n    res.status(statusCode).json(err);\n  }\n}\n\nfunction handleError(res, statusCode) {\n  statusCode = statusCode || 500;\n  return function(err) {\n    res.status(statusCode).send(err);\n  };\n}\n\n/**\n * Get list of users\n * restriction: 'admin'\n */\nexport function index(req, res) {\n  return User.findAll({\n    attributes: [\n      '_id',\n      'name',\n      'email',\n      'role',\n      'provider'\n    ]\n  })\n    .then(users => {\n      res.status(200).json(users);\n    })\n    .catch(handleError(res));\n}\n\n/**\n * Creates a new user\n */\nexport function create(req, res, next) {\n  var newUser = User.build(req.body);\n  newUser.setDataValue('provider', 'local');\n  newUser.setDataValue('role', 'user');\n  return newUser.save()\n    .then(function(user) {\n      var token = jwt.sign({ _id: user._id }, config.secrets.session, {\n        expiresIn: 60 * 60 * 5\n      });\n      res.json({ token });\n    })\n    .catch(validationError(res));\n}\n\n/**\n * Get a single user\n */\nexport function show(req, res, next) {\n  var userId = req.params.id;\n\n  return User.find({\n    where: {\n      _id: userId\n    }\n  })\n    .then(user => {\n      if (!user) {\n        return res.status(404).end();\n      }\n      res.json(user.profile);\n    })\n    .catch(err => next(err));\n}\n\n/**\n * Deletes a user\n * restriction: 'admin'\n */\nexport function destroy(req, res) {\n  return User.destroy({ _id: req.params.id })\n    .then(function() {\n      res.status(204).end();\n    })\n    .catch(handleError(res));\n}\n\n/**\n * Change a users password\n */\nexport function changePassword(req, res, next) {\n  var userId = req.user._id;\n  var oldPass = String(req.body.oldPassword);\n  var newPass = String(req.body.newPassword);\n\n  return User.find({\n    where: {\n      _id: userId\n    }\n  })\n    .then(user => {\n      if (user.authenticate(oldPass)) {\n        user.password = newPass;\n        return user.save()\n          .then(() => {\n            res.status(204).end();\n          })\n          .catch(validationError(res));\n      } else {\n        return res.status(403).end();\n      }\n    });\n}\n\n/**\n * Get my info\n */\nexport function me(req, res, next) {\n  var userId = req.user._id;\n\n  return User.find({\n    where: {\n      _id: userId\n    },\n    attributes: [\n      '_id',\n      'name',\n      'email',\n      'role',\n      'provider'\n    ]\n  })\n    .then(user => { // don't ever give out the password or salt\n      if (!user) {\n        return res.status(401).end();\n      }\n      res.json(user);\n    })\n    .catch(err => next(err));\n}\n\n/**\n * Authentication callback\n */\nexport function authCallback(req, res, next) {\n  res.redirect('/');\n}\n"]}